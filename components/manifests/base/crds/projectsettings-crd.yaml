apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: projectsettings.vteam.ambient-code
spec:
  group: vteam.ambient-code
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        x-kubernetes-validations:
        - rule: "self.metadata.name == 'projectsettings'"
          message: "metadata.name must be 'projectsettings' (singleton per namespace)"
        properties:
          spec:
            type: object
            required:
            - groupAccess
            properties:
              groupAccess:
                type: array
                description: "Group access configuration creating RoleBindings"
                items:
                  type: object
                  required:
                  - groupName
                  - role
                  properties:
                    groupName:
                      type: string
                      description: "Name of the group to grant access"
                    role:
                      type: string
                      enum:
                      - "admin"
                      - "edit"
                      - "view"
                      description: "Role to assign to the group (admin/edit/view)"
              runnerSecretsName:
                type: string
                description: "Name of the Kubernetes Secret in this namespace that stores runner configuration key/value pairs"
              repositories:
                type: array
                description: "Git repositories configured for this project"
                items:
                  type: object
                  required:
                  - url
                  properties:
                    url:
                      type: string
                      description: "Repository URL (HTTPS or SSH format)"
                    branch:
                      type: string
                      description: "Optional branch override (defaults to repository's default branch)"
                    provider:
                      type: string
                      enum:
                      - "github"
                      - "gitlab"
                      description: "Git hosting provider (auto-detected from URL if not specified)"
              workspaceContainer:
                type: object
                description: "Workspace container configuration for ADR-0006 agent isolation. Optional customization - sessions always run in workspace containers using the platform default image if not specified."
                properties:
                  image:
                    type: string
                    description: "Custom container image for workspace pods (optional - uses platform default if not specified)"
                  resources:
                    type: object
                    description: "Resource requirements for workspace containers"
                    properties:
                      cpuRequest:
                        type: string
                        description: "CPU request (e.g., 250m)"
                      cpuLimit:
                        type: string
                        description: "CPU limit (e.g., 2)"
                      memoryRequest:
                        type: string
                        description: "Memory request (e.g., 512Mi)"
                      memoryLimit:
                        type: string
                        description: "Memory limit (e.g., 2Gi)"
          status:
            type: object
            properties:
              groupBindingsCreated:
                type: integer
                minimum: 0
                description: "Number of group RoleBindings successfully created"
    additionalPrinterColumns:
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: projectsettings
    singular: projectsetting
    kind: ProjectSettings
    shortNames:
    - ps


