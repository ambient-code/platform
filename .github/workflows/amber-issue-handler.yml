# Amber Issue-to-PR Handler
#
# This workflow automates issue resolution via the Amber background agent.
#
# TRIGGERS:
# - Issue labeled with: amber:auto-fix, amber:refactor, amber:test-coverage
# - Issue comment containing: /amber execute or @amber
#
# BEHAVIOR:
# - Checks for existing open PR for the issue (prevents duplicate PRs)
# - Creates or updates feature branch: amber/issue-{number}-{sanitized-title}
# - Runs Claude Code to implement changes
# - Creates PR or pushes to existing PR
#
# SECURITY:
# - Validates branch names against injection attacks
# - Uses gh CLI search for PR lookup (no regex on untrusted input)
# - Handles race conditions when PRs are closed during execution

name: Amber Issue-to-PR Handler

on:
  issues:
    types: [labeled, opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write  # Required for OIDC token (Bedrock/Vertex/Foundry/OAuth)

jobs:
  amber-handler:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Issue #7: Prevent runaway jobs
    # Only run for specific labels, commands, or @amber mentions
    if: |
      (github.event.label.name == 'amber:auto-fix' ||
       github.event.label.name == 'amber:refactor' ||
       github.event.label.name == 'amber:test-coverage' ||
       contains(github.event.comment.body, '/amber execute') ||
       contains(github.event.comment.body, '@amber'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine Amber action type
        id: action-type
        env:
          LABEL_NAME: ${{ github.event.label.name }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Parse label or comment to determine action
          if [[ "$LABEL_NAME" == "amber:auto-fix" ]]; then
            echo "type=auto-fix" >> $GITHUB_OUTPUT
            echo "severity=low" >> $GITHUB_OUTPUT
          elif [[ "$LABEL_NAME" == "amber:refactor" ]]; then
            echo "type=refactor" >> $GITHUB_OUTPUT
            echo "severity=medium" >> $GITHUB_OUTPUT
          elif [[ "$LABEL_NAME" == "amber:test-coverage" ]]; then
            echo "type=test-coverage" >> $GITHUB_OUTPUT
            echo "severity=medium" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT_BODY" == *"/amber execute"* ]] || [[ "$COMMENT_BODY" == *"@amber"* ]]; then
            # Treat @amber mentions same as /amber execute - let Claude figure out the intent
            echo "type=execute-proposal" >> $GITHUB_OUTPUT
            echo "severity=medium" >> $GITHUB_OUTPUT
          else
            echo "type=unknown" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Extract issue details
        id: issue-details
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_JSON=$(gh issue view "$ISSUE_NUMBER" --json number,title,body)
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT

          BODY=$(echo "$ISSUE_JSON" | jq -r '.body // ""')
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Use issue title as instructions (Claude receives the full body via the prompt template)
          TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          echo "instructions=$TITLE" >> $GITHUB_OUTPUT

      - name: Create Amber agent prompt
        id: create-prompt
        env:
          ISSUE_NUMBER: ${{ steps.issue-details.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue-details.outputs.issue_title }}
          ISSUE_INSTRUCTIONS: ${{ steps.issue-details.outputs.instructions }}
          ACTION_TYPE: ${{ steps.action-type.outputs.type }}
          ACTION_SEVERITY: ${{ steps.action-type.outputs.severity }}
        run: |
          cat > /tmp/amber-prompt.md <<'EOF'
          # Amber Agent Task: Issue #${ISSUE_NUMBER}

          **Action Type:** ${ACTION_TYPE}
          **Severity:** ${ACTION_SEVERITY}

          ## Issue Details
          **Title:** ${ISSUE_TITLE}

          **Instructions:**
          ${ISSUE_INSTRUCTIONS}

          ## Your Mission

          Based on the action type, perform the following:

          ### For `auto-fix` type:
          1. Identify the specific linting/formatting issues mentioned
          2. Run appropriate formatters (gofmt, black, prettier, etc.)
          3. Fix any trivial issues (unused imports, spacing, etc.)
          4. Ensure all changes pass existing tests
          5. Create a clean commit with conventional format

          ### For `refactor` type:
          1. Analyze the current code structure
          2. Implement the refactoring as described in the issue
          3. Ensure backward compatibility (no breaking changes)
          4. Add/update tests to cover refactored code
          5. Verify all existing tests still pass

          ### For `test-coverage` type:
          1. Analyze current test coverage for specified files
          2. Identify untested code paths
          3. Write contract tests following project standards (see CLAUDE.md)
          4. Ensure tests follow table-driven test pattern (Go) or pytest patterns (Python)
          5. Verify all new tests pass

          ### For `execute-proposal` type:
          1. Read the full issue body for the proposed implementation
          2. Execute the changes as specified in the proposal
          3. Follow the risk assessment and rollback plan provided
          4. Ensure all testing strategies are implemented

          ## Requirements

          - Follow all standards in `CLAUDE.md`
          - Use conventional commit format: `type(scope): message`
          - Run all linters BEFORE committing:
            - Go: `gofmt -w .`, `golangci-lint run`
            - Python: `black .`, `isort .`, `flake8`
            - TypeScript: `npm run lint`
          - Ensure ALL tests pass: `make test`
          - Create branch following pattern: `amber/issue-${ISSUE_NUMBER}-{description}`

          ## Success Criteria

          - All linters pass with 0 warnings
          - All existing tests pass
          - New code follows project conventions
          - Commit message is clear and follows conventional format
          - Changes are focused on issue scope (no scope creep)

          ## Output Format

          After completing the work, provide:
          1. **Summary of changes** (2-3 sentences)
          2. **Files modified** (list with line count changes)
          3. **Test results** (pass/fail for each test suite)
          4. **Linting results** (confirm all pass)
          5. **Commit SHA**

          Ready to execute!
          EOF

          # Substitute environment variables
          envsubst < /tmp/amber-prompt.md > amber-prompt.md

          echo "prompt_file=amber-prompt.md" >> $GITHUB_OUTPUT

      - name: Check for existing PR
        id: check-existing-pr
        env:
          ISSUE_NUMBER: ${{ steps.issue-details.outputs.issue_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Validate issue number is numeric to prevent injection
          if ! [[ "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid issue number format"
            exit 1
          fi

          # Use gh search to find open PRs that close this issue
          EXISTING_PR=$(gh pr list --state open --search "Closes #${ISSUE_NUMBER}" \
            --json number,headRefName --jq '.[0] // empty' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            EXISTING_BRANCH=$(echo "$EXISTING_PR" | jq -r '.headRefName')

            # Validate branch name format to prevent command injection
            if ! [[ "$EXISTING_BRANCH" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
              echo "Error: Invalid branch name format in existing PR"
              echo "existing_pr=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "existing_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "existing_branch=$EXISTING_BRANCH" >> $GITHUB_OUTPUT
            echo "Found existing PR #$PR_NUMBER on branch $EXISTING_BRANCH"
          else
            echo "existing_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR found for issue #${ISSUE_NUMBER}"
          fi

      - name: Create or checkout feature branch
        id: create-branch
        env:
          ISSUE_NUMBER: ${{ steps.issue-details.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue-details.outputs.issue_title }}
          EXISTING_PR: ${{ steps.check-existing-pr.outputs.existing_pr }}
          EXISTING_BRANCH: ${{ steps.check-existing-pr.outputs.existing_branch }}
        run: |
          git config user.name "Amber Agent"
          git config user.email "amber@ambient-code.ai"

          # Validate issue number format
          if ! [[ "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid issue number format"
            exit 1
          fi

          checkout_branch() {
            local branch="$1"
            local is_existing="$2"

            # Validate branch name format (alphanumeric, slashes, dashes, dots, underscores only)
            if ! [[ "$branch" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
              echo "Error: Invalid branch name format: $branch"
              return 1
            fi

            echo "Attempting to checkout branch: $branch"
            if git fetch origin "$branch" 2>/dev/null; then
              git checkout -B "$branch" "origin/$branch"
              echo "Checked out existing remote branch: $branch"
            elif [ "$is_existing" == "true" ]; then
              # Race condition: PR existed but branch was deleted
              echo "Warning: Branch $branch no longer exists on remote (PR may have been closed)"
              return 1
            else
              echo "Creating new branch: $branch"
              git checkout -b "$branch"
            fi
            return 0
          }

          if [ "$EXISTING_PR" == "true" ] && [ -n "$EXISTING_BRANCH" ]; then
            # Try to checkout existing PR branch with race condition handling
            if ! checkout_branch "$EXISTING_BRANCH" "true"; then
              echo "Existing PR branch unavailable, falling back to new branch creation"
              # Fall through to create new branch
              EXISTING_PR="false"
            else
              BRANCH_NAME="$EXISTING_BRANCH"
            fi
          fi

          if [ "$EXISTING_PR" != "true" ]; then
            # Create new branch with sanitized title
            # Sanitization: lowercase, replace non-alphanumeric with dash, collapse dashes, trim
            SANITIZED_TITLE=$(echo "$ISSUE_TITLE" \
              | tr '[:upper:]' '[:lower:]' \
              | sed 's/[^a-z0-9-]/-/g' \
              | sed 's/--*/-/g' \
              | sed 's/^-//' \
              | sed 's/-$//' \
              | cut -c1-50)

            BRANCH_NAME="amber/issue-${ISSUE_NUMBER}-${SANITIZED_TITLE}"

            # Validate the generated branch name
            if ! [[ "$BRANCH_NAME" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
              echo "Error: Generated branch name is invalid: $BRANCH_NAME"
              exit 1
            fi

            checkout_branch "$BRANCH_NAME" "false" || exit 1
          fi

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Using branch: $BRANCH_NAME"

      - name: Read prompt file
        id: read-prompt
        run: |
          PROMPT_CONTENT=$(cat amber-prompt.md)
          # Use heredoc to safely handle multiline content
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          cat amber-prompt.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Execute Amber agent via Claude Code
        id: amber-execute
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # Run Claude Code with full tool access (you make the rules!)
          cat amber-prompt.md | claude --print --dangerously-skip-permissions || true
          echo "Claude Code execution completed"

      - name: Check if changes were made
        id: check-changes
        run: |
          # Check if there are any new commits on this branch vs main
          CURRENT_BRANCH=$(git branch --show-current)
          COMMITS_AHEAD=$(git rev-list --count origin/main.."$CURRENT_BRANCH" 2>/dev/null || echo "0")

          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by Amber (no new commits)"
          else
            COMMIT_SHA=$(git rev-parse HEAD)
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "branch_name=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
            echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
            echo "Changes committed on branch $CURRENT_BRANCH (commit: ${COMMIT_SHA:0:7})"
            echo "Commits ahead of main: $COMMITS_AHEAD"
          fi

      - name: Report no changes
        if: steps.check-changes.outputs.has_changes == 'false'
        env:
          ISSUE_NUMBER: ${{ steps.issue-details.outputs.issue_number }}
          ACTION_TYPE: ${{ steps.action-type.outputs.type }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "$(cat <<EOF
          âœ… Amber reviewed this issue but found no changes were needed.

          **Action Type:** ${ACTION_TYPE}

          **Possible reasons:**
          - Files are already properly formatted
          - No linting issues found
          - The requested changes may have already been applied

          If you believe changes are still needed, please provide more specific instructions or file paths in the issue description.

          ---
          ðŸ” [View AI decision process](${RUN_URL}) (logs available for 90 days)
          EOF
          )"

      - name: Push branch to remote
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          BRANCH_NAME: ${{ steps.check-changes.outputs.branch_name }}
        run: |
          git push -u origin "$BRANCH_NAME"
          echo "Pushed branch $BRANCH_NAME to remote"

      - name: Validate changes align with issue intent
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          ISSUE_NUMBER: ${{ steps.issue-details.outputs.issue_number }}
          EXISTING_PR: ${{ steps.check-existing-pr.outputs.existing_pr }}
          EXISTING_PR_NUMBER: ${{ steps.check-existing-pr.outputs.pr_number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          DIFF_STAT=$(git diff HEAD~1 --stat)

          if [ "$EXISTING_PR" == "true" ]; then
            NEXT="Changes pushed to existing PR #${EXISTING_PR_NUMBER}"
          else
            NEXT="A PR will be created shortly for formal review"
          fi

          gh issue comment "$ISSUE_NUMBER" --body "$(cat <<EOF
          ## Amber Change Summary

          The following files were modified:

          \`\`\`
          ${DIFF_STAT}
          \`\`\`

          **Next Steps:** ${NEXT}

          ---
          ðŸ” [View AI decision process](${RUN_URL}) (logs available for 90 days)
          EOF
          )"

      - name: Create or Update Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          BRANCH_NAME: ${{ steps.check-changes.outputs.branch_name }}
          COMMIT_SHA: ${{ steps.check-changes.outputs.commit_sha }}
          ISSUE_NUMBER: ${{ steps.issue-details.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue-details.outputs.issue_title }}
          ACTION_TYPE: ${{ steps.action-type.outputs.type }}
          EXISTING_PR: ${{ steps.check-existing-pr.outputs.existing_pr }}
          EXISTING_PR_NUMBER: ${{ steps.check-existing-pr.outputs.pr_number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          SHORT_SHA="${COMMIT_SHA:0:7}"

          if [ "$EXISTING_PR" == "true" ] && [ -n "$EXISTING_PR_NUMBER" ]; then
            # Update existing PR
            gh pr comment "$EXISTING_PR_NUMBER" --body "$(cat <<EOF
          ðŸ¤– **Amber pushed additional changes**

          - **Commit:** ${SHORT_SHA}
          - **Action Type:** ${ACTION_TYPE}

          New changes have been pushed to this PR. Please review the updated code.

          ---
          ðŸ” [View AI decision process](${RUN_URL}) (logs available for 90 days)
          EOF
            )"

            gh issue comment "$ISSUE_NUMBER" --body \
              "ðŸ¤– Amber pushed additional changes to PR #${EXISTING_PR_NUMBER}. [View run](${RUN_URL})"
          else
            # Create new PR
            PR_URL=$(gh pr create \
              --title "[Amber] Fix: ${ISSUE_TITLE}" \
              --head "$BRANCH_NAME" \
              --base main \
              --body "$(cat <<EOF
          ## Automated Fix by Amber Agent

          This PR addresses issue #${ISSUE_NUMBER}.

          ### Changes Summary
          - **Action Type:** ${ACTION_TYPE}
          - **Commit:** ${SHORT_SHA}

          ### Pre-merge Checklist
          - [ ] All linters pass
          - [ ] All tests pass
          - [ ] Changes follow project conventions (CLAUDE.md)
          - [ ] No scope creep beyond issue description

          ---
          ðŸ¤– Generated with Amber Background Agent

          Closes #${ISSUE_NUMBER}
          EOF
            )")

            # Extract PR number and add labels (best-effort)
            PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
            gh pr edit "$PR_NUMBER" --add-label "amber-generated,auto-fix,${ACTION_TYPE}" 2>/dev/null || true

            gh issue comment "$ISSUE_NUMBER" --body \
              "ðŸ¤– Amber created PR #${PR_NUMBER} to address this issue. [View run](${RUN_URL})"
          fi

      - name: Report failure
        if: failure()
        env:
          ISSUE_NUMBER: ${{ steps.issue-details.outputs.issue_number }}
          ACTION_TYPE: ${{ steps.action-type.outputs.type }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Validate issue number before attempting comment
          if ! [[ "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid issue number, cannot post failure comment"
            exit 0
          fi

          gh issue comment "$ISSUE_NUMBER" --body "$(cat <<EOF
          âš ï¸ Amber encountered an error while processing this issue.

          **Action Type:** ${ACTION_TYPE:-unknown}
          **Workflow Run:** ${RUN_URL}

          Please review the workflow logs for details. Manual intervention may be required.
          EOF
          )" || echo "Warning: Failed to post failure comment"
